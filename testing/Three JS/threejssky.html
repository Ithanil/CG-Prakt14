<html>
	<head>
		<title>BOWLING!!!</title> 
		<style>canvas { width: 100%; height: 100% }</style> 
	</head> 
	<body> 
		<script src="three.js"></script> 
		<script src="OrbitControls.js"></script>
		<script type="text/javascript" src="sugar.js"></script>
		<script type="text/javascript" src="gl-matrix.js"></script>
		<script type="text/javascript" src="dat.gui.js"></script>
		<script type="text/javascript" src="pintest.js"></script>
		<script type="text/javascript" src="ball.js"></script>
		<script type="text/javascript" src="userInterface.js"></script>
		<script> 
		
			
	var renderer, camera, controls, moreLight, directionalLight;
	
	// custom global variables
	var back, lane, approach, pinVertices, ballOffset, ball;
	var time=0.0;
	
	
	var slices = 10; 		// Pin slices
	
	var pins;
			
	var posarr = [[0.0,0.0,-18.29/2],
				[0.3048/2,0.0,-18.29/2-0.264],[-0.3048/2,0.0,-18.29/2-0.264],
				[0.3048,0.0,-18.29/2-0.264*2],[0.0,0.0,-18.29/2-0.264*2],[-0.3048,0.0,-18.29/2-0.264*2],
				[0.3048*3/2,0.0,-18.29/2-0.264*3],[0.3048/2,0.0,-18.29/2-0.264*3],[-0.3048/2,0.0,-18.29/2-0.264*3],[-0.3048*3/2,0.0,-18.29/2-0.264*3]];
	
	var V0=5; //Velocity at the beginning
	var a=[9.81*0.12,9.81*0.12,9.81*0.12]; //gleitreibung
	var angle=0; //throwing angle -45,45
	
	
	init();
	animate();
	createUi();
		
	function init(){
		document.addEventListener("keydown", keyDown, false);
		scene = new THREE.Scene(); 
		// PerspectiveCamera(fovy, aspect, near, far)
		var SCREEN_WIDTH = window.innerWidth, SCREEN_HEIGHT = window.innerHeight;
		var VIEW_ANGLE = 45, ASPECT = SCREEN_WIDTH / SCREEN_HEIGHT, NEAR = 0.1, FAR = 20000;
		camera = new THREE.PerspectiveCamera( VIEW_ANGLE, ASPECT, NEAR, FAR);
		scene.add(camera);
		controls = new THREE.OrbitControls( camera );
		controls.addEventListener( 'change', render );
		controls.target.z=-6;
		camera.position.z=15;
		camera.position.y=1;
						
		renderer = new THREE.WebGLRenderer(); 
		renderer.setSize( window.innerWidth, window.innerHeight ); 
		renderer.setClearColor( 0xffffff, 1 );	// Canvas Background Color
		document.body.appendChild( renderer.domElement );
		
		// Bahn
		var laneTexture = new THREE.ImageUtils.loadTexture("textures/wood.jpg");
		laneTexture.wrapS = laneTexture.wrapT = THREE.RepeatWrapping;
		laneTexture.repeat.set( 3,25 );
		var lane_material = new THREE.MeshPhongMaterial( {  map:laneTexture, side:THREE.DoubleSide } ); 
		lane = new THREE.Mesh( new THREE.CubeGeometry(1.05,0.1,18.29+2), lane_material ); 
		lane.translateY(-0.05);
		lane.translateZ(-1);
		lane.receiveShadow = true;
		scene.add( lane );  
		
		//generate ball and pins
		ball= new BowlBall([0,0,0],[0,0,0]);
		pins = createPins();
		
		// Approach
		var appr_geometry = new THREE.CubeGeometry(1.05,0.1,2.0); 
		var appr_material = new THREE.MeshBasicMaterial( { color: 0x5C3D1F } ); 
		approach = new THREE.Mesh( appr_geometry, appr_material ); 
		approach.translateZ(18.29/2.0+2.0/2);
		approach.translateY(-0.05);
		scene.add( approach ); 
		
		// Plattform
		var plattform_material = new THREE.MeshPhongMaterial( { color: 0x339933 } ); 
		var plattform = new THREE.Mesh( new THREE.CylinderGeometry( 15,15,1, 5), plattform_material ); 
		plattform.translateY(-0.5-0.1);
		scene.add( plattform ); 
		
		// Box hinten
		var boxBack = new THREE.Mesh(
			new THREE.CubeGeometry(1.05+2*0.2359+0.5*2,1.25,0.75),
			new THREE.MeshPhongMaterial({ color: 0x996633 })
		);
		boxBack.translateY(1.25/2-0.1);
		boxBack.translateZ(-18.29/2-1.3-0.75);
		scene.add(boxBack);
		
		var boxLR = new THREE.CubeGeometry(0.5,1.25,0.25);
		var boxLR_material = new THREE.MeshPhongMaterial({ color: 0x996633 });
		var boxL = new THREE.Mesh(boxLR, boxLR_material);
		boxL.translateX(1.05/2+0.2359+0.5/2);
		boxL.translateY(1.25/2-0.1);
		boxL.translateZ(-18.29/2-1.3+0.5-0.75);
		scene.add(boxL);
		var boxR = new THREE.Mesh(boxLR, boxLR_material);
		boxR.translateX(-1.05/2-0.2359-0.5/2);
		boxR.translateY(1.25/2-0.1);
		boxR.translateZ(-18.29/2-1.3+0.5-0.75);
		scene.add(boxR);
		
		var boxUp = new THREE.Mesh(
			new THREE.CubeGeometry(1.05+2*0.2359,0.5,0.25),
			new THREE.MeshPhongMaterial({ color: 0x996633 })
		);
		boxUp.translateY(-0.1+1);
		boxUp.translateZ(-18.29/2-1.3+0.5-0.75);
		scene.add(boxUp);
		
		//Das schwarze Ding hinten
		var black = new THREE.Mesh( 
			new THREE.CubeGeometry(1.05+0.2359*2,1.0,0.1), new THREE.MeshBasicMaterial( {color: 0x000000} )
		);
		black.translateY(-0.1+0.5);
		black.translateZ(-18.29/2-1.3-0.20);
		scene.add( black );
		
		// rinne au√üen
		var limits_material = new THREE.MeshPhongMaterial({color: 0x000000});
		var limitsR = new THREE.Mesh(new THREE.CubeGeometry(0.2359,0.1,18.29+2), limits_material);
		var limitsL = new THREE.Mesh(new THREE.CubeGeometry(0.2359,0.1,18.29+2), limits_material);
		limitsR.translateX(1.05/2+0.2359/2);
		limitsR.translateY(-0.05);
		limitsR.translateZ(-1);
		scene.add(limitsR);
		limitsL.translateX(-1.05/2-0.2359/2);
		limitsL.translateY(-0.05);
		limitsL.translateZ(-1);
		scene.add(limitsL);

		// Position oder Kamera
		//camera.position.set( 4, 4, 21 );
		//camera.lookAt( scene.position );
		//KAMERA auf die Pins
		
		
		//Schattenwurf
		moreLight = new THREE.DirectionalLight(0xffffff, 0.5);
		moreLight.position.set(0,1,0);
		scene.add(moreLight);
			
		// Ambient Directional light Test
		directionalLight = new THREE.DirectionalLight(0xffffff);
		//directionalLight.position.set(1,1.5,1).normalize();
		directionalLight.target.position.set(0,0,-18.29/2);
		directionalLight.shadowCameraNear = 2;
		directionalLight.shadowCameraFar = 15;
		directionalLight.shadowCameraLeft = -0.5;
		directionalLight.shadowCameraRight = 0.5;
		directionalLight.shadowCameraTop = 0.5;
		directionalLight.shadowCameraBottom = -0.5;
		directionalLight.shadowCameraVisible = false;
		directionalLight.castShadow = true;
		scene.add(directionalLight);
	
		// SKYBOX
		var sky_geometry = new THREE.CubeGeometry( 10000, 10000, 10000 );    
		var images = ["skybox/right.jpg", "skybox/left.jpg", 
			"skybox/up.jpg", "skybox/down.jpg", 
			"skybox/front.jpg", "skybox/back.jpg"];
		var sky_material_array = [];
		for (var i = 0; i < 6; i++)
			sky_material_array.push( new THREE.MeshBasicMaterial({
				map: THREE.ImageUtils.loadTexture( images[i] ),
				side: THREE.BackSide
			}));
		var sky_material = new THREE.MeshFaceMaterial( sky_material_array );
		var skybox = new THREE.Mesh(sky_geometry, sky_material);
		skybox.rotation.y -=2.35;
		scene.add(skybox);
		// SKYBOX ENDE*/
	}
		
	
	function animate() {
		requestAnimationFrame( animate );
		moveBall();
		
		render();
		controls.update();
	}
	
	function moveBall(){
		if (ball.velocity.x>0.0001) ball.velocity.x = ball.velocity.x-time*a[0]*Math.sin(Math.PI/180.0*angle);
			else if (ball.velocity.x<-0.0001)ball.velocity.x = ball.velocity.x+time*a[0]*Math.sin(Math.PI/180.0*angle);
			else ball.velocity.x=0;
		if (ball.velocity.y>0.0001) ball.velocity.y = ball.velocity.y-time*a[1];
			else if (ball.velocity.y<-0.0001)ball.velocity.y = ball.velocity.y+time*a[1];
			ball.velocity.y = 0;
		if(ball.velocity.z>0.0001)ball.velocity.z = ball.velocity.z-time*a[2]*Math.cos(Math.PI/180.0*angle);
			else ball.velocity.z=0;
		if(ball.velocity.z<0){
			ball.velocity.x = 0;
			ball.velocity.y =0 ;
			ball.velocity.z = 0;
			}
		ball.translateZ(-time*ball.velocity.z);
		ball.translateY(time*ball.velocity.y);
		ball.translateX(time*ball.velocity.x);
	}
	// Renderer
	function render() { 
		renderer.shadowMapEnabled = true;

		renderer.shadowMapBias = 0.0039;
		renderer.shadowMapDarkness = 0.5;
		renderer.shadowMapWidth = 1024;
		renderer.shadowMapHeight = 1024; 
		renderer.render(scene, camera); 
	} 
	V0=5;
		
	function keyDown(event) {

		switch(event.keyCode) {

      case 65: ///Key A
		 putPins(pins,posarr);
		 
		 //putPins(slices);
         break;
      case 68: ///Key D
		 scene.remove(ball);
         drawBall([0,0.11,10]);
         break;
      case 87: ///Key W
         time=0.01;
		 ball.velocity.x=V0*Math.sin(Math.PI/180.0*angle);
		 ball.velocity.y=0;
		 ball.velocity.z=V0*Math.cos(Math.PI/180.0*angle);
         break;
      case 83: ///Key S
         ;
         break;
      default:
         break;
		}
		animate();
	}			
	
	function drawBall(r){
	//scene.remove(ball);
	  time=0;
	  ball.position.set(r[0],r[1],r[2]); 
	  scene.add(ball);
	  }
	
	//var animationstep = window.setInterval("timing()",50);

	  
	  
	</script>
	
	</body>
</html>
